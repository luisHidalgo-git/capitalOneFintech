<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Banca Web • Dashboard</title>
<meta name="theme-color" content="#ffffff" />
<style>
  :root{
    --bg:#ffffff; --panel:#f7f8fb; --panel-2:#eef2f7; --border:#d6dee8;
    --text:#0f1b2d; --muted:#6b7280; --brand:#003a6d; --brand-2:#0a6cbe; --brand-3:#0b4e8a;
    --green:#16a34a; --red:#dc2626; --radius:18px; --shadow:0 8px 18px rgba(0,0,0,.06);
    --sidebar-w:260px; --topbar-h:64px;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--text); background:var(--bg)}
  .app{min-height:100vh; display:grid; grid-template-columns:var(--sidebar-w) 1fr; grid-template-rows:var(--topbar-h) 1fr; grid-template-areas:"sidebar topbar" "sidebar main";}
  /* Sidebar */
  .sidebar{grid-area:sidebar; background:var(--panel); border-right:1px solid var(--border); display:flex; flex-direction:column; gap:12px; padding:100px 12px;}
  .btn-card{position:relative; overflow:hidden; display:grid; grid-template-columns:48px 1fr; align-items:center; gap:14px; padding:14px 16px; border-radius:22px; border:1px solid var(--border); background:#fff; box-shadow:var(--shadow); cursor:pointer; text-align:left; transition:transform .06s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;}
  .btn-card:hover{ transform:translateY(-1px); box-shadow:0 10px 22px rgba(0,0,0,.08) }
  .btn-card:active{ transform:translateY(0) scale(.99) }
  .btn-ico{ width:48px; height:48px; border-radius:14px; display:grid; place-items:center; border:2px solid var(--border); background:#fff; color:#0f1b2d }
  .btn-ico svg{ width:24px; height:24px; stroke:currentColor; stroke-width:1.8; fill:none }
  .btn-titles{display:grid; line-height:1.1}
  .btn-titles .title{font-weight:800}
  .btn-titles .sub{font-size:12px; color:var(--muted)}
  .btn-card.active{ background:linear-gradient(180deg,var(--brand-2),var(--brand-3)); border-color:transparent; color:#fff; box-shadow:0 10px 24px rgba(0,72,140,.25)}
  .btn-card.active .btn-ico{background:rgba(255,255,255,.15); border-color:rgba(255,255,255,.35); color:#fff}
  .btn-card.active .btn-titles .sub{ color:rgba(255,255,255,.9) }
  @media (max-width:880px){
    .app{grid-template-columns:1fr; grid-template-areas:"topbar" "main"}
    .sidebar{position:fixed; left:0; top:var(--topbar-h); height:calc(100dvh - var(--topbar-h)); width:var(--sidebar-w); transform:translateX(-100%); transition:transform .25s ease; z-index:950; padding-top:16px;}
    .sidebar.open{ transform:none }
  }
  .overlay{position:fixed; left:0, right:0; top:var(--topbar-h); height:calc(100dvh - var(--topbar-h)); background:rgba(0,0,0,.22); display:none; z-index:900;}
  .overlay.show{ display:block }
  /* Topbar */
  .topbar{grid-area:topbar; height:var(--topbar-h); display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:8px; padding:10px 14px; background:#fff; border-bottom:1px solid var(--border); position:sticky; top:0; z-index:1000;}
  .top-left{justify-self:start}
  .top-center{justify-self:center; display:inline-flex; align-items:center; gap:12px}
  .top-right{justify-self=end; display:flex; gap:8px}
  .co-logo{height:26px}
  .app-title{font-weight:800; color:var(--brand); font-size:18px}
  .iconbtn{position:relative; overflow:hidden; width:40px; height:40px; display:grid; place-items:center; border-radius:12px; border:1px solid var(--border); background:#fff; box-shadow:var(--shadow); cursor:pointer; transition:transform .06s ease, box-shadow .2s ease, background .2s ease;}
  .iconbtn:hover{ transform:translateY(-1px) }
  #burger{display:none}
  @media (max-width:880px){ #burger{display:grid} }
  /* Main */
  main{grid-area:main; padding:16px}
  .grid{display:grid; gap:16px}
  @media (min-width:900px){
    .grid{grid-template-columns:1.1fr .9fr; grid-template-areas:"saldo tarjeta" "movs movs"; align-items:start;}
    .card--saldo{grid-area:saldo}
    .card--tarjeta{grid-area:tarjeta}
    .card--movs{grid-area:movs}
  }
  .card{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}
  .card h3{margin:0 0 10px; color:var(--brand)}
  .total{display:flex; align-items:flex-end; gap:10px}
  .total h2{margin:0; font-size:32px; color:var(--brand)}
  .pill{padding:4px 8px; border-radius:999px; font-size:12px; background:var(--panel-2); color:var(--muted)}
  .divider{height:1px; background:var(--border); margin:12px 0}
  .saldo-actions h4{margin:0 0 8px; color:var(--brand)}
  .quick{display:grid; grid-template-columns:repeat(auto-fit,minmax(210px,1fr)); gap:16px}
  .qbtn{position:relative; overflow:hidden; display:grid; grid-template-columns:48px 1fr; align-items:center; gap:14px; padding:14px 16px; border-radius:22px; border:1px solid var(--border); background:#fff; box-shadow:var(--shadow); cursor:pointer; text-align:left; transition:transform .06s ease, box-shadow .2s ease, background .2s ease;}
  .qbtn:hover{ transform:translateY(-1px); box-shadow:0 10px 22px rgba(242, 242, 242, 0.08) }
  .qbtn .btn-ico{ width:48px; height:48px; border-radius:14px; display:grid; place-items:center; border:2px solid var(--border); background:#fff; color:#0f1b2d }
  .qbtn .btn-ico svg{ width:24px; height:24px; stroke:currentColor; stroke-width:1.8; fill:none }
  .qbtn .btn-titles .title{font-weight:800}
  .qbtn .btn-titles .sub{font-size:12px; color:var(--muted)}
  .tx-list{display:grid; gap:12px}
  .tx{display:flex; justify-content:space-between; align-items:center; background:#fff; border:1px solid var(--border); border-radius:16px; padding:12px; box-shadow:var(--shadow)}
  .avatar{width:40px; height:40px; border-radius:12px; background:var(--panel-2); display:grid; place-items:center; font-weight:800; color:var(--brand)}
  .meta{font-size:12px; color:var(--muted)}
  .amount.in{color:var(--green); font-weight:700}
  .amount.out{color:var(--red); font-weight:700}
  .credit .progress{height:10px; background:var(--panel-2); border-radius:999px; overflow:hidden; margin:10px 0}
  .credit .progress span{display:block; height:100%; background:linear-gradient(90deg,#e85050,#f87171); width:42%}
  .card-actions{display:flex; flex-wrap:wrap; gap:12px; margin-top:12px}
  .tbtn{position:relative; overflow:hidden; flex:1 1 200px; display:grid; grid-template-columns:48px 1fr; align-items:center; gap:14px; padding:12px 14px; border-radius:18px; border:1px solid var(--border); background:#fff; box-shadow:var(--shadow); cursor:pointer; text-align:left; transition:transform .06s ease, box-shadow .2s ease, background .2s ease, border .2s ease;}
  .tbtn:hover{ transform:translateY(-1px); box-shadow:0 10px 22px rgba(0,0,0,.08) }
  .tbtn .btn-ico{ width:48px; height:48px; border-radius:14px; display:grid; place-items:center; border:2px solid var(--border); background:#fff; color:#0f1b2d }
  .tbtn .btn-ico svg{ width:24px; height:24px; stroke:currentColor; stroke-width:1.8; fill:none }
  .tbtn .btn-titles .title{ font-weight:800 }
  .tbtn .btn-titles .sub{ font-size:12px; color:var(--muted) }
  .tbtn.block.active{ background:#e85050; color:#fff; border-color:#e85050 }
  .tbtn.block.active .btn-ico{ background:rgba(255,255,255,.15); color:#fff; border-color:#fff }
  .tbtn.block.active .btn-titles .sub{ color:#fff }
  @keyframes pop { 0%{transform:scale(1)} 50%{transform:scale(0.92)} 100%{transform:scale(1)} }
  .pop-ico .btn-ico{ animation:pop .18s ease }
  .ripple { position:absolute; border-radius:999px; transform:scale(0); background:rgba(0,0,0,.12); animation:ripple .6s linear; pointer-events:none; }
  @keyframes ripple { to { transform:scale(12); opacity:0; } }

  /* ---- TOASTS ---- */
  #toasts{position:fixed; right:16px; top:16px; z-index:2000; display:grid; gap:10px}
  .toast{min-width:260px; max-width:380px; padding:12px 14px; border-radius:14px;
    box-shadow:0 10px 28px rgba(0,0,0,.12); color:#0f1b2d; background:#fff; border:1px solid #e5e7eb;
    display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px; animation:slideIn .25s ease}
  .toast.success{border-color:#bbf7d0; background:#f0fdf4}
  .toast.error{border-color:#fecaca; background:#fef2f2}
  .toast.info{border-color:#bfdbfe; background:#eff6ff}
  .toast .title{font-weight:800}
  .toast .msg{font-size:13px; color:#475569}
  .toast .close{cursor:pointer; padding:4px 8px; border-radius:8px}
  .toast .close:hover{background:rgba(0,0,0,.06)}
  @keyframes slideIn{from{transform:translateY(-8px); opacity:0} to{transform:none; opacity:1}}

  /* ---- MODALES ---- */
  .modal-backdrop{position:fixed; inset:0; background:rgba(15,27,45,.36); display:none; z-index:1900}
  .modal{position:fixed; inset:0; display:none; place-items:center; z-index:1950}
  .modal.show,.modal-backdrop.show{display:grid}
  .modal-card{width:min(560px,92vw); background:#fff; border:1px solid #e5e7eb; border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.25); overflow:hidden}
  .modal-header{padding:14px 16px; font-weight:800; color:#003a6d; border-bottom:1px solid #e5e7eb}
  .modal-body{padding:16px; color:#0f1b2d; white-space:pre-wrap; line-height:1.6}
  .modal-body strong{color:var(--brand); font-weight:700}
  .modal-body ul{margin:8px 0; padding-left:20px}
  .modal-body li{margin:6px 0}
  .modal-footer{display:flex; gap:10px; justify-content:flex-end; padding:14px 16px; background:#f8fafc; border-top:1px solid #e5e7eb}
  .mbtn{padding:10px 14px; border-radius:10px; border:1px solid #d6dee8; background:#fff; cursor:pointer}
  .mbtn.primary{background:linear-gradient(90deg,#003a6d,#0a6cbe); color:#fff; border-color:transparent}
  .mbtn.warn{background:#ef4444; color:#fff; border-color:#ef4444}

  /* Inputs modal */
  .form-row{display:grid; gap:8px; margin:10px 0}
  .form-row input[type="text"], .form-row input[type="number"]{
    width:100%; padding:10px; border-radius:10px; border:1px solid #cdd5e1; outline:none}
  .form-row input:focus-visible{border-color:#0a6cbe; box-shadow:0 0 0 3px rgba(10,108,190,.15)}
  .radio-row{display:flex; gap:12px; flex-wrap:wrap}
  .radio-pill{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid #cdd5e1; border-radius:999px; cursor:pointer}
  .radio-pill input{accent-color:#0a6cbe}
</style>
</head>
<body>
<div class="app">
  <!-- ===== SIDEBAR ===== -->
  <aside class="sidebar" id="sidebar">
    <div class="btn-card" data-static="true" id="ownerCard" style="cursor:default">
      <span class="btn-ico">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 20a8 8 0 0 1 16 0"/></svg>
      </span>
      <span class="btn-titles"><span class="title" id="ownerName">Titular de la cuenta</span><span class="sub">Cliente</span></span>
    </div>

    <button class="btn-card active sb-btn" data-route="dashboard">
      <span class="btn-ico">
        <svg viewBox="0 0 24 24"><path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-10.5Z"/></svg>
      </span>
      <span class="btn-titles"><span class="title">Inicio</span><span class="sub">Resumen</span></span>
    </button>

    <button class="btn-card sb-btn" data-route="cuentas">
      <span class="btn-ico">
        <svg viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M3 10h18"/></svg>
      </span>
      <span class="btn-titles"><span class="title">Cuentas</span><span class="sub">Saldos y CLABE</span></span>
    </button>

    <button class="btn-card sb-btn" data-route="transferir">
      <span class="btn-ico">
        <svg viewBox="0 0 24 24"><path d="M4 7h11l-3-3m3 3-3 3M20 17H9l3 3m-3-3 3-3" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </span>
      <span class="btn-titles"><span class="title">Transferir</span><span class="sub">Enviar dinero</span></span>
    </button>

    <button class="btn-card sb-btn" data-route="movimientos">
      <span class="btn-ico">
        <svg viewBox="0 0 24 24"><path d="M3 7h18M3 12h18M3 17h18"/></svg>
      </span>
      <span class="btn-titles"><span class="title">Movimientos</span><span class="sub">Historial</span></span>
    </button>

    <div class="spacer"></div>

    <button class="btn-card sb-btn" data-route="ajustes">
      <span class="btn-ico">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a2 2 0 0 0 .3 2.1l.1.1a2 2 0 1 1-2.8 2.8l-.1-.1"/></svg>
      </span>
      <span class="btn-titles"><span class="title">Ajustes</span><span class="sub">Preferencias</span></span>
    </button>
  </aside>
  <div class="overlay" id="overlay"></div>

  <!-- ===== TOPBAR ===== -->
  <header class="topbar">
    <div class="top-left">
      <button class="iconbtn" id="burger" aria-label="Abrir/Cerrar menú">☰</button>
    </div>
    <div class="top-center">
      <img class="co-logo" src="https://upload.wikimedia.org/wikipedia/commons/9/98/Capital_One_logo.svg" alt="Capital One">
      <span class="app-title">Banca Web</span>
    </div>
    <div class="top-right">
      <button class="iconbtn" id="notifBtn">🔔</button>
      <button class="iconbtn" id="logoutBtn" title="Cerrar sesión">⎋</button>
    </div>
  </header>

  <!-- ===== MAIN ===== -->
  <main>
    <section id="view-dashboard" class="view active">
      <div class="grid">
        <!-- Saldo + Acciones rápidas -->
        <article class="card card--saldo">
          <div class="total"><h2 id="totalAmount">$ —</h2><span class="pill">Saldo total</span></div>
          <p class="muted" id="accountsLine">Cuentas vinculadas</p>

          <div class="divider"></div>

          <div class="saldo-actions">
            <h4>Acciones rápidas</h4>
            <div class="quick">
              <button class="qbtn" id="qaPagos">
                <span class="btn-ico">
                  <svg viewBox="0 0 24 24"><path d="M3 7h18v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7Z"/><path d="M3 11h18M7 15h4"/></svg>
                </span>
                <span class="btn-titles"><span class="title">Pagar</span><span class="sub">Servicios</span></span>
              </button>

              <button class="qbtn tbtn block" id="qaBloquear">
                <span class="btn-ico">
                  <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="10" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                </span>
                <span class="btn-titles"><span class="title">Bloquear tarjeta</span><span class="sub">Desactivar temporalmente</span></span>
              </button>

              <button class="qbtn" id="qaDetalles">
                <span class="btn-ico">
                  <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8h.01M12 12v4"/></svg>
                </span>
                <span class="btn-titles"><span class="title">Detalles</span><span class="sub">Ver información</span></span>
              </button>
            </div>
          </div>
        </article>

        <!-- Tarjeta -->
        <article class="card credit card--tarjeta">
          <h3>Tarjeta •••• 7789</h3>
          <p class="muted">Corte: 28 Sep · Vence: 15 Oct</p>
          <div>Saldo actual: <strong id="ccSaldo">$ 0.00</strong></div>
          <div class="progress"><span id="ccUso" style="width:0%"></span></div>

          <div class="card-actions">
            <button class="tbtn pay" id="payCardBtn">
              <span class="btn-ico">
                <svg viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2"/><path d="M2 10h20"/></svg>
              </span>
              <span class="btn-titles"><span class="title">Pagar tarjeta</span><span class="sub">Visa ••7789</span></span>
            </button>

            <button class="tbtn block" id="bloquearTarjeta">
              <span class="btn-ico">
                <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="10" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
              </span>
              <span class="btn-titles"><span class="title">Bloquear tarjeta</span><span class="sub">Desactivar temporalmente</span></span>
            </button>

            <button class="tbtn details" id="detallesBtn">
              <span class="btn-ico">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8h.01M12 12v4"/></svg>
              </span>
              <span class="btn-titles"><span class="title">Detalles</span><span class="sub">Ver información</span></span>
            </button>
          </div>
        </article>

        <!-- Movimientos -->
        <article class="card card--movs">
          <h3>Movimientos</h3>
          <div class="tx-list" id="txList"></div>
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:12px">
            <button id="btnPrev" class="qbtn" style="padding:8px 12px; border-radius:12px">
              <span class="btn-titles"><span class="title">Anterior</span></span>
            </button>
            <div class="muted" id="pagerInfo">Página 1 de 1</div>
            <button id="btnNext" class="qbtn" style="padding:8px 12px; border-radius:12px">
              <span class="btn-titles"><span class="title">Siguiente</span></span>
            </button>
          </div>
        </article>

      </div>
    </section>
  </main>
</div>

<!-- Toasts y Modales -->
<div id="toasts" aria-live="polite"></div>
<div id="backdrop" class="modal-backdrop"></div>

<div id="confirmModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
  <div class="modal-card">
    <div class="modal-header" id="confirmTitle">Confirmar acción</div>
    <div class="modal-body"><div id="confirmMsg"></div></div>
    <div class="modal-footer">
      <button class="mbtn" id="confirmNo">Cancelar</button>
      <button class="mbtn primary" id="confirmYes">Continuar</button>
    </div>
  </div>
</div>

<div id="payModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="payTitle">
  <div class="modal-card">
    <div class="modal-header" id="payTitle">Registrar movimiento</div>
    <div class="modal-body">
      <div class="form-row">
        <label>Motivo</label>
        <input id="pmMotivo" type="text" placeholder="Luz, Renta, Super…">
      </div>
      <div class="form-row">
        <label>Monto (MXN)</label>
        <input id="pmMonto" type="number" min="0" step="0.01" placeholder="0.00">
      </div>
      <div class="form-row">
        <label>Método</label>
        <div class="radio-row">
          <label class="radio-pill"><input type="radio" name="pmTipo" value="debito" checked> Débito (usa saldo)</label>
          <label class="radio-pill"><input type="radio" name="pmTipo" value="credito"> Crédito (tarjeta)</label>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="mbtn" id="pmCancel">Cancelar</button>
      <button class="mbtn primary" id="pmOk">Registrar</button>
    </div>
  </div>
</div>

<div id="payCardModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="payCardTitle">
  <div class="modal-card">
    <div class="modal-header" id="payCardTitle">Pagar tarjeta</div>
    <div class="modal-body">
      <div class="form-row">
        <label>Monto a pagar (MXN)</label>
        <input id="pcmMonto" type="number" min="0" step="0.01" placeholder="0.00">
      </div>
    </div>
    <div class="modal-footer">
      <button class="mbtn" id="pcmCancel">Cancelar</button>
      <button class="mbtn primary" id="pcmOk">Pagar</button>
    </div>
  </div>
</div>

<script>
  // -------- util --------
  const fmt = n => Number(n||0).toLocaleString('es-MX',{style:'currency',currency:'MXN'});
  const $  = sel => document.querySelector(sel);

  /* ===== TOASTS ===== */
  function showToast(title, msg='', type='info', ms=3200){
    const box = document.getElementById('toasts');
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.innerHTML = `
      <div class="title">${title}</div>
      <div class="msg">${msg}</div>
      <div class="close">✖</div>
    `;
    el.querySelector('.close').onclick = ()=> el.remove();
    box.appendChild(el);
    setTimeout(()=> el.remove(), ms);
  }

  /* ===== MODALES ===== */
  const backdrop = document.getElementById('backdrop');
  function openModal(id){ backdrop.classList.add('show'); document.getElementById(id).classList.add('show'); }
  function closeModal(id){ document.getElementById(id).classList.remove('show'); backdrop.classList.remove('show'); }

  function uiConfirm(message, title='Confirmar'){
    return new Promise(resolve=>{
      $('#confirmTitle').textContent = title;
      const msgEl = $('#confirmMsg');
      // Si el mensaje contiene HTML, usamos innerHTML; si no, textContent
      if(message.includes('<strong>') || message.includes('<ul>')){
        msgEl.innerHTML = message;
      } else {
        msgEl.textContent = message;
      }
      openModal('confirmModal');
      const yes = $('#confirmYes'), no = $('#confirmNo');
      const cleanup = ()=>{ yes.onclick=no.onclick=null; closeModal('confirmModal'); };
      yes.onclick = ()=>{ cleanup(); resolve(true); };
      no.onclick  = ()=>{ cleanup(); resolve(false); };
    });
  }

  function uiPayDialog(){
    return new Promise(resolve=>{
      const m = $('#pmMotivo'), monto = $('#pmMonto');
      m.value=''; monto.value='';
      document.querySelectorAll('input[name="pmTipo"]').forEach(r=> r.checked = r.value==='debito');
      openModal('payModal');

      const ok = $('#pmOk'), cancel = $('#pmCancel');
      const end = (val)=>{ ok.onclick=cancel.onclick=null; closeModal('payModal'); resolve(val); };
      cancel.onclick = ()=> end(null);
      ok.onclick = ()=>{
        const motivo = m.value.trim();
        const val = Number(monto.value);
        const tipo = document.querySelector('input[name="pmTipo"]:checked')?.value || 'debito';
        if(!motivo){ showToast('Falta el motivo','Escribe un concepto','error'); return; }
        if(!val || val<=0){ showToast('Monto inválido','Ingresa un número mayor a 0','error'); return; }
        end({motivo, monto: val, tipo});
      };
    });
  }

  function uiCardPayDialog(){
    return new Promise(resolve=>{
      const monto = $('#pcmMonto'); monto.value='';
      openModal('payCardModal');
      const ok = $('#pcmOk'), cancel = $('#pcmCancel');
      const end = (val)=>{ ok.onclick=cancel.onclick=null; closeModal('payCardModal'); resolve(val); };
      cancel.onclick = ()=> end(null);
      ok.onclick = ()=>{
        const v = Number(monto.value);
        if(!v || v<=0){ showToast('Monto inválido','Ingresa un número mayor a 0','error'); return; }
        end(v);
      };
    });
  }

  // ====== TARJETA DINÁMICA ======
  const CREDIT_LIMIT = 30000; // ajusta tu línea de crédito
  function updateCreditUI(deuda){
    const uso = Math.max(0, Math.min(1, Number(deuda||0)/CREDIT_LIMIT));
    $('#ccSaldo').textContent = fmt(Number(deuda||0));
    $('#ccUso').style.width = (uso*100).toFixed(0)+'%';
  }

  // -------- sesión obligatoria + nombre ----------
  async function requireSession(){
    const r = await fetch('/api/me'); const d = await r.json();
    if(!d.user){ location.href = '/'; return null; }
    const full = [d.user.nombre, d.user.apellido].filter(Boolean).join(' ') || d.user.correo;
    $('#ownerName').textContent = full;
    return d.user;
  }

  // -------- dashboard data ----------
  async function loadDashboard(){
    const r = await fetch('/api/dashboard');
    if(!r.ok) throw new Error('No se pudo cargar el dashboard');
    const d = await r.json();

    $('#totalAmount').textContent = fmt(d.saldo);
    $('#accountsLine').textContent = 'Cuentas: Corriente ••1234 · Ahorro ••9981';
    updateCreditUI(d.deuda_credito || 0);
  }

  // ---- Paginación de movimientos ----
  let MOV_PAGE = 1;
  const MOV_PER_PAGE = 6;

  async function loadMovs(page = 1){
    const r = await fetch(`/api/movimientos?page=${page}&per_page=${MOV_PER_PAGE}`);
    const d = await r.json();
    if(!r.ok){ showToast('Error','No se pudieron cargar los movimientos','error'); return; }

    MOV_PAGE = d.page;
    const list = document.getElementById('txList'); list.innerHTML = '';
    (d.movimientos||[]).forEach(m=>{
      const div = document.createElement('div'); div.className='tx';
      const initials = (m.motivo||'?').trim().split(/\s+/).slice(0,2).map(s=>s[0]).join('').toUpperCase();
      const fecha = (m.fecha||'').substring(0,10);
      const isIn = (m.tipo||'debito') === 'credito';
      const sideClass = isIn ? 'in' : 'out';
      const sign = m.signo || (isIn?'+':'-');
      div.innerHTML = `
        <div style="display:flex; align-items:center; gap:12px">
          <div class="avatar">${initials}</div>
          <div><div>${m.motivo}</div><div class="meta">${fecha} · ${m.tipo}</div></div>
        </div>
        <div class="amount ${sideClass}">${sign} ${fmt(Math.abs(m.monto))}</div>
      `;
      list.appendChild(div);
    });

    $('#pagerInfo').textContent = `Página ${d.page} de ${d.pages || 1}`;
    $('#btnPrev').disabled = !d.has_prev;
    $('#btnNext').disabled = !d.has_next;
  }

  // -------- pagar / comprar con evaluación previa ----------
  async function quickPayFlow(){
    const info = await uiPayDialog();
    if(!info) return;

    const rs = await fetch('/api/saldo');
    if(!rs.ok){ showToast('Error','No se pudo leer tu saldo','error'); return; }
    const sd = await rs.json();
    const saldo = Number(sd.saldo||0);

    const ev = await fetch('/api/evaluar', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ saldo, suscripciones: 0, esencial: 1, nuevo_gasto: info.monto })
    });
    const ed = await ev.json().catch(()=> ({}));
    if(!ev.ok){ showToast('Error al evaluar', ed.error || 'Intenta de nuevo', 'error'); return; }

    if(ed.alerta){
      const mensaje = formatAIMessage(ed.mensaje || 'Este gasto puede ser riesgoso. ¿Continuar?');
      const ok = await uiConfirm(mensaje, '⚠️ Alerta financiera');
      if(!ok) return;
    }

    const rp = await fetch('/api/pago', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ motivo: info.motivo, monto: info.monto, tipo: info.tipo })
    });
    const pd = await rp.json().catch(()=> ({}));
    if(!rp.ok){ showToast('No se registró', pd.error || 'Error al registrar pago','error'); return; }

    const nuevo = Number(pd.nuevo_saldo);
    if (!Number.isNaN(nuevo)) $('#totalAmount').textContent = fmt(nuevo);
    updateCreditUI(pd.nueva_deuda_credito || 0);
    await loadMovs(MOV_PAGE);

    showToast('Movimiento registrado',
              `Saldo: ${fmt(pd.nuevo_saldo)} · Deuda tarjeta: ${fmt(pd.nueva_deuda_credito||0)}`,
              'success', 4200);
  }

  // Formatea el mensaje de la IA para mejor legibilidad
  function formatAIMessage(msg){
    if(!msg) return msg;
    // Convierte bullet points en HTML
    let formatted = msg
      .replace(/^(\d+\.)\s/gm, '<strong>$1</strong> ')
      .replace(/^-\s/gm, '• ')
      .replace(/\n\n/g, '\n')
      .replace(/Recomendaciones:/gi, '<strong>Recomendaciones:</strong>');
    return formatted;
  }

  // -------- UI: sidebar + ripple + tarjeta block ----------
  const sidebar = $('#sidebar'), overlay = $('#overlay'), burger = $('#burger');
  function toggleSidebar(){
    const open = !sidebar.classList.contains('open');
    sidebar.classList.toggle('open', open); overlay.classList.toggle('show', open);
    burger.textContent = open ? '✖' : '☰';
  }
  burger?.addEventListener('click', toggleSidebar);
  overlay.addEventListener('click', toggleSidebar);
  function handleResize(){
    if (window.innerWidth > 880){ sidebar.classList.remove('open'); overlay.classList.remove('show'); burger.style.display='none'; }
    else { burger.style.display='grid'; burger.textContent='☰'; }
  }
  window.addEventListener('resize', handleResize); handleResize();

  function attachEffects(selector){
    document.querySelectorAll(selector).forEach(btn=>{
      if(btn.dataset.static==="true") return;
      btn.addEventListener('click', (e)=>{
        btn.classList.add('pop-ico'); setTimeout(()=>btn.classList.remove('pop-ico'), 200);
        const rect = btn.getBoundingClientRect(); const ripple = document.createElement('span');
        const size = Math.max(rect.width, rect.height);
        ripple.className='ripple'; ripple.style.width=ripple.style.height=size+'px';
        ripple.style.left=(e.clientX-rect.left-size/2)+'px'; ripple.style.top=(e.clientY-rect.top-size/2)+'px';
        btn.appendChild(ripple); ripple.addEventListener('animationend', ()=> ripple.remove());
      });
    });
  }
  attachEffects('.tbtn, .qbtn, .btn-card, .iconbtn');

  const bloquearTarjeta = document.getElementById('bloquearTarjeta');
  bloquearTarjeta.addEventListener('click', () => {
    bloquearTarjeta.classList.toggle('active');
    const t = bloquearTarjeta.querySelector('.title');
    const s = bloquearTarjeta.querySelector('.sub');
    if (bloquearTarjeta.classList.contains('active')) {
      t.textContent = 'Tarjeta bloqueada'; s.textContent = 'Presiona para desbloquear';
    } else {
      t.textContent = 'Bloquear tarjeta'; s.textContent = 'Desactivar temporalmente';
    }
  });
  const qaBloquear = document.getElementById('qaBloquear');
  qaBloquear.addEventListener('click', () => {
    qaBloquear.classList.toggle('active');
    const t = qaBloquear.querySelector('.title');
    const s = qaBloquear.querySelector('.sub');
    if (qaBloquear.classList.contains('active')) { t.textContent='Tarjeta bloqueada'; s.textContent='Presiona para desbloquear'; }
    else { t.textContent='Bloquear tarjeta'; s.textContent='Desactivar temporalmente'; }
  });

  // -------- acciones --------
  document.getElementById('qaPagos').addEventListener('click', quickPayFlow);
  document.getElementById('qaDetalles').addEventListener('click', async ()=>{
    const rs = await fetch('/api/saldo');
    if(!rs.ok){ showToast('Error','No se pudo cargar información','error'); return; }
    const sd = await rs.json();
    const msg = `Saldo disponible: ${fmt(sd.saldo)}\nDeuda tarjeta: ${fmt(sd.deuda_credito)}\nMoneda: ${sd.moneda}`;
    await uiConfirm(msg, 'Detalles de cuenta');
  });

  document.getElementById('detallesBtn')?.addEventListener('click', async ()=>{
    const rs = await fetch('/api/saldo');
    if(!rs.ok){ showToast('Error','No se pudo cargar información','error'); return; }
    const sd = await rs.json();
    const limite = CREDIT_LIMIT;
    const disponible = limite - Number(sd.deuda_credito||0);
    const msg = `Tarjeta Visa ••7789\n\nLínea de crédito: ${fmt(limite)}\nDeuda actual: ${fmt(sd.deuda_credito)}\nDisponible: ${fmt(disponible)}\n\nCorte: 28 Sep\nPago mínimo: ${fmt(sd.deuda_credito * 0.05)}\nVencimiento: 15 Oct`;
    await uiConfirm(msg, 'Detalles de tarjeta');
  });
  document.getElementById('btnPrev').addEventListener('click', ()=> loadMovs(MOV_PAGE - 1));
  document.getElementById('btnNext').addEventListener('click', ()=> loadMovs(MOV_PAGE + 1));
  document.getElementById('logoutBtn').addEventListener('click', async ()=>{ await fetch('/api/logout',{method:'POST'}); location.href='/'; });

  // Botón Pagar tarjeta (modal)
  document.getElementById('payCardBtn')?.addEventListener('click', async ()=>{
    const monto = await uiCardPayDialog();
    if(!monto) return;

    // Verificar saldo antes de pagar
    const rs = await fetch('/api/saldo');
    if(!rs.ok){ showToast('Error','No se pudo verificar tu saldo','error'); return; }
    const sd = await rs.json();
    const saldoActual = Number(sd.saldo||0);
    const deudaActual = Number(sd.deuda_credito||0);

    if(saldoActual <= 0){
      showToast('Saldo insuficiente','No tienes saldo disponible para pagar la tarjeta','error');
      return;
    }

    if(deudaActual <= 0){
      showToast('Sin deuda','No tienes deuda de tarjeta por pagar','info');
      return;
    }

    const r = await fetch('/api/pagar_tarjeta', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({monto})
    });
    const d = await r.json().catch(()=> ({}));
    if(!r.ok){ showToast('No se pudo pagar la tarjeta', d.error || 'Intenta más tarde','error'); return; }

    $('#totalAmount').textContent = fmt(d.nuevo_saldo);
    updateCreditUI(d.nueva_deuda_credito || 0);
    await loadMovs(MOV_PAGE);

    const msg = d.ajustado
      ? `Se pagó ${fmt(d.monto_pagado)} (ajustado al máximo disponible)`
      : `Se pagó ${fmt(d.monto_pagado)} correctamente`;
    showToast('Pago aplicado', msg, 'success', 4500);
  });

  // -------- init --------
  (async function(){
    const u = await requireSession(); if(!u) return;
    await loadDashboard();
    await loadMovs(1);
  })();
</script>
</body>
</html>
